#requires -RunAsAdministrator 
<#
.SYNOPSIS
    Mitigation script for CVE-2022-30190 Microsoft Support Diagnostic Tool Vulnerability
    https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/
.DESCRIPTION
    Mitigation script for CVE-2022-30190 Microsoft Support Diagnostic Tool Vulnerability
    https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/
.NOTES
    2022-06-01 Jack den Ouden <jack@ldam.nl>
        Script created
.EXAMPLE
    .\Fix-msdt.ps1
.EXAMPLE
    .\Fix-msdt.ps1 -Restore
#>

[CmdletBinding()]
param (
    [Parameter()]
    [switch][bool]
    $Restore
)

if (!($Restore)) {

    #test if registry key exists
    if (Test-Path -Path "registry::HKEY_CLASSES_ROOT\ms-msdt") {
        #Test if directory present if not create
        if (!(Test-Path -Path "C:\RegBackup")) {
            New-Item -Path "C:\RegBackup" -ItemType Directory -Force | Out-Null
        }
    
        #Backup registrykey
        Start-Process -FilePath "regedit.exe " `
            -ArgumentList "/E `"C:\RegBackup\ms-msdt.reg`" `"HKEY_CLASSES_ROOT\ms-msdt`"" `
            -WindowStyle Hidden `
            -Wait
        
        #Remove the registry key
        Remove-Item -Path "registry::HKEY_CLASSES_ROOT\ms-msdt" -Force -Recurse
    }
    else {
        #Test if directory present if not create
        if (!(Test-Path -Path "C:\RegBackup")) {
            New-Item -Path "C:\RegBackup" -ItemType Directory -Force | Out-Null
        }

        "Registry key not found" | Out-File "C:\RegBackup\ms-msdt.txt"

    }

}
else {

    #test if registry backup is present
    if (Test-Path -Path "C:\RegBackup\ms-msdt.reg") {
        
        #Restore from backup
        regedit.exe /S "C:\RegBackup\ms-msdt.reg"

    }
    else {
        throw "No backup file found"
    }


}
